<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mesh Sensory Layer</title>
  <link rel="stylesheet" href="mesh.css?v=15" />
</head>
<body>
  <a href="index.html" class="back-button">← Back</a>

  <section class="screen screen-bubbles show" aria-label="Mesh Sensory Layer">
    <div class="bg"></div>
    <div class="overlay"></div>

    <div class="inner">
      <header class="section-header">
        <h1>Mesh Sensory Layer</h1>
        <p>Semi-transparent mesh bends depth and vision. Projection and daylight weave shadows so surfaces feel in flux.</p>
      </header>

      <div class="bubble-container">
        <button class="bubble" type="button"><span class="bubble-label">Material</span><span class="bubble-text">Metal/polymer meshes diffract light at different densities.</span></button>
        <button class="bubble" type="button"><span class="bubble-label">Texture</span><span class="bubble-text">Fine/coarse grids create moiré as you move.</span></button>
        <button class="bubble" type="button"><span class="bubble-label">Ambience</span><span class="bubble-text">Layered shadows keep edges unstable.</span></button>
      </div>

      <button class="continue-btn" type="button">Continue</button>
    </div>
  </section>

  <section class="screen screen-choices" aria-label="Where will you wander next?">
    <div class="choice-question">Where will you wander next?</div>

    <div class="choice choice-left" tabindex="0" role="link">
      <img class="choice-img" src="" alt="" />
      <div class="choice-content"><h3 class="choice-text"></h3></div>
    </div>

    <div class="choice choice-right" tabindex="0" role="link">
      <img class="choice-img" src="" alt="" />
      <div class="choice-content"><h3 class="choice-text"></h3></div>
    </div>

    <div class="choice-or" aria-hidden="true">OR</div>

    <div class="final-wrap" hidden>
      <img class="final-img" src="" alt="" />
      <div class="final-overlay">
        <h2 class="final-title">You’re almost there—proceed to the final space.</h2>
        <button class="final-continue" type="button">Continue</button>
      </div>
    </div>
  </section>

  <div class="screen-fade" aria-hidden="true"></div>

  <script>
    const PAGE='mesh';
    const NEXT={ fuzzy:['fabric','mesh'], fabric:['fuzzy','mesh'], mesh:['fabric','ceiling'], ceiling:['fuzzy','mesh'] };
    const LABEL={ fuzzy:'Return to the Fuzzy space', fabric:'Step into the Fabric space', mesh:'Move through the Mesh environment', ceiling:'Look up at the Wooden Ceiling' };

    const getVisited=()=>{try{return JSON.parse(localStorage.getItem('visitedSpaces')||'[]');}catch{return[];}};
    const setVisited=(a)=>localStorage.setItem('visitedSpaces',JSON.stringify(Array.from(new Set(a))));
    const addVisited=(s)=>{const v=getVisited(); if(!v.includes(s)){v.push(s); setVisited(v);}};

    addVisited(PAGE);

    document.addEventListener('click',e=>{const b=e.target.closest('.bubble'); if(!b)return; b.classList.toggle('active');});

    const bubbles=document.querySelector('.screen-bubbles');
    const choices=document.querySelector('.screen-choices');
    const fade=document.querySelector('.screen-fade');

    document.querySelector('.continue-btn').addEventListener('click',()=>{
      bubbles.classList.remove('show');
      renderChoices();
      choices.classList.add('show');
      window.scrollTo(0,0);
    });

    const go=(url)=>{fade.classList.add('in'); setTimeout(()=>location.href=url,250);};

    function wire(el,next){
      el.querySelector('.choice-img').src=`${next}.png`;
      el.querySelector('.choice-text').textContent=LABEL[next];
      el.dataset.target=`${PAGE}-${next}.html`;
      el.onclick=()=>go(el.dataset.target);
      el.onkeydown=(e)=>{if(e.key==='Enter'||e.key===' '){e.preventDefault(); go(el.dataset.target);}};
      el.removeAttribute('hidden');
    }

    function renderChoices(){
      const visited=getVisited();
      let remaining=NEXT[PAGE].filter(s=>!visited.includes(s));

      const left=document.querySelector('.choice-left');
      const right=document.querySelector('.choice-right');
      const orEl=document.querySelector('.choice-or');
      const final=document.querySelector('.final-wrap');
      const fImg=document.querySelector('.final-img');
      const fBtn=document.querySelector('.final-continue');

      [left,right].forEach(el=>el.setAttribute('hidden',''));

      if(remaining.length>=2){
        wire(left,remaining[0]); wire(right,remaining[1]);
        orEl.removeAttribute('hidden'); final.setAttribute('hidden','');
      }else if(remaining.length===1){
        fImg.src=`${remaining[0]}.png`;
        fBtn.onclick=()=>go(`${PAGE}-${remaining[0]}.html`);
        final.removeAttribute('hidden'); orEl.setAttribute('hidden','');
      }else{
        location.href='index.html';
      }
    }
  </script>
</body>
</html>
